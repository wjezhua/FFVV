<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Fuerza de Ventas</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b1020;
      color: #fff;
    }
    header { padding: 1rem; text-align: center; }
    select, button {
      margin: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }
    button.active { background: #4CAF50; color: #fff; }
    .container { max-width: 1200px; margin: auto; padding: 1rem; }
    .general-card {
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .general-card h2 { margin: 0 0 .5rem; }
    .kpi {
      background: rgba(255,255,255,0.05);
      margin: 0.25rem 0;
      padding: 0.5rem;
      border-radius: 8px;
    }
    .kpi canvas {
      width: 100%;
      height: 60px !important;
      margin-top: 6px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .card {
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .card img {
      width: 100px; height: 100px; border-radius: 50%;
      object-fit: cover; margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Dashboard Fuerza de Ventas</h1>
    <div>
      <label for="year">Año:</label>
      <select id="year"></select>
      <label for="month">Mes:</label>
      <select id="month"></select>
    </div>
    <div>
      <button id="btnComisional" class="active">Comisional</button>
      <button id="btnIncentivos">Incentivos</button>
    </div>
  </header>

  <div class="container">
    <div id="general-summary"></div>
    <div id="cards" class="cards"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ventasURL = "data/ventas.json";
    const incentivosURL = "data/incentivos.json";
    let currentData = "ventas";
    const charts = {};

    const fmtNumber = n => (Number(n)||0).toLocaleString('es-PE',{maximumFractionDigits:1});
    const formatPercent = (a,m) => {
      let pct = (m>0 ? (a/m*100) : 0);
      return pct.toFixed(1) + "%";
    };
    const kpiId = k => "sumchart-"+k.replace(/[^a-zA-Z0-9]/g,"_");

    function renderGeneralByKPI(vendedores, year, month){
      const totales={};
      vendedores.forEach(v=>{
        Object.entries(v.kpis||{}).forEach(([k,vals])=>{
          if(!totales[k]) totales[k]={avance:0,meta:0};
          totales[k].avance += Number(vals.avance)||0;
          totales[k].meta += Number(vals.meta)||0;
        });
      });

      const cont=document.getElementById("general-summary");
      const keys=Object.keys(totales);
      if(keys.length===0){cont.innerHTML="";return;}

      let html=`<div class="general-card"><h2>TOTAL POR KPI ${month}/${year}</h2>`;
      keys.forEach(k=>{
        const a=totales[k].avance,m=totales[k].meta,p=m>0?(a/m*100):0;
        html+=`<div class="kpi"><strong>${k}</strong>: ${fmtNumber(a)} de ${fmtNumber(m)} — ${p.toFixed(1)}%<canvas id="${kpiId(k)}"></canvas></div>`;
      });
      html+=`</div>`;
      cont.innerHTML=html;

      // dibujar charts
      keys.forEach(k=>{
        const id=kpiId(k);
        const a=totales[k].avance,m=totales[k].meta,p=m>0?(a/m*100):0;
        if(charts[id]){charts[id].destroy();}
        const ctx=document.getElementById(id);
        charts[id]=new Chart(ctx,{
          type:"line",
          data:{
            labels:["0%","50%","100%"],
            datasets:[
              {
                label:"Avance",
                data:[0,p,p],
                borderColor:"#4CAF50",
                tension:0.4,
                fill:false
              },
              {
                label:"Meta (100%)",
                data:[100,100,100],
                borderColor:"red",
                borderDash:[5,5],
                fill:false,
                tension:0
              }
            ]
          },
          options:{
            responsive:true,maintainAspectRatio:false,
            plugins:{legend:{labels:{color:"#fff"}},tooltip:{enabled:true}},
            scales:{
              x:{display:true,ticks:{color:"#fff"}},
              y:{
                min:0,max:160,
                ticks:{color:"#fff",stepSize:20,callback:v=>v+"%"}
              }
            },
            elements:{point:{radius:0}}
          }
        });
      });
    }

    function renderCards(vendedores,year,month){
      renderGeneralByKPI(vendedores,year,month);
      const div=document.getElementById("cards");div.innerHTML="";
      vendedores.forEach(v=>{
        const c=document.createElement("div");c.className="card";
        const vigente=v.vigente?"<em>Mes en curso</em>":"";
        c.innerHTML=`<img src="images/${v.foto}" alt="${v.nombre}"><h3>${v.nombre}</h3><p>${vigente}</p><div class="kpis"></div>`;
        const kp=c.querySelector(".kpis");
        Object.entries(v.kpis||{}).forEach(([k,vals])=>{
          kp.innerHTML+=`<div class="kpi"><strong>${k}</strong>: ${fmtNumber(vals.avance)} de ${fmtNumber(vals.meta)} — ${formatPercent(vals.avance,vals.meta)}</div>`;
        });
        div.appendChild(c);
      });
    }

    async function loadData(){
      const y=document.getElementById("year").value;
      const m=document.getElementById("month").value;
      const url=currentData==="ventas"?ventasURL:incentivosURL;
      const data=await (await fetch(url)).json();
      const vendedores=data?.[y]?.[m]||[];
      renderCards(vendedores,y,m);
    }

    function init(){
      const now=new Date();
      const yS=document.getElementById("year"),mS=document.getElementById("month");
      for(let y=now.getFullYear()-1;y<=now.getFullYear()+1;y++){let o=document.createElement("option");o.value=y;o.text=y;if(y===now.getFullYear())o.selected=true;yS.appendChild(o);}
      for(let m=1;m<=12;m++){let o=document.createElement("option");o.value=String(m).padStart(2,"0");o.text=o.value;if(m===now.getMonth()+1)o.selected=true;mS.appendChild(o);}
      yS.addEventListener("change",loadData);mS.addEventListener("change",loadData);
      document.getElementById("btnComisional").onclick=()=>{currentData="ventas";btnComisional.classList.add("active");btnIncentivos.classList.remove("active");loadData();}
      document.getElementById("btnIncentivos").onclick=()=>{currentData="incentivos";btnIncentivos.classList.add("active");btnComisional.classList.remove("active");loadData();}
      loadData();
    }
    init();
  </script>
</body>
</html>
