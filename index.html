<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Fuerza de Ventas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ðŸ“Œ LibrerÃ­as para exportar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #111;
      color: #fff;
    }

    /* ðŸ”¹ Header moderno */
    header {
      background: rgba(20, 30, 40, 0.85);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
    }
    header .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.6em;
      font-weight: 700;
      color: #fff;
    }
    header .subtitle {
      font-size: 0.9em;
      opacity: 0.8;
      color: #ccc;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
    }
    select, button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      font-size: 0.95em;
      background: rgba(255,255,255,0.08);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }
    select:hover, button:hover {
      background: #007bff;
      color: #fff;
    }
    button.active {
      background: #007bff;
      font-weight: bold;
    }

    /* ðŸ“± Responsive mÃ³vil */
    @media (max-width: 600px) {
      header {
        padding: 10px 15px;
        gap: 8px;
      }
      header h1 {
        font-size: 1.3em;
      }
      header .subtitle {
        font-size: 0.8em;
      }
      .toolbar {
        flex-direction: column;
        gap: 8px;
      }
      select, button {
        width: 100%;
        font-size: 1em;
        padding: 10px;
      }
    }

    /* ðŸ”¹ Contenido */
    .container {
      padding: 20px;
    }

    .totales {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .totales h2 {
      margin-top: 0;
      font-size: 1.4em;
    }

    .kpi-total {
      margin-bottom: 25px;
    }

    canvas {
      margin-top: 10px;
      max-height: 150px;
    }

    /* ðŸ”¹ Cards de vendedores */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .card img {
      width: 90px;
      height: 90px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: 12px;
      border: 3px solid #007bff;
    }

    .card h3 {
      margin: 8px 0;
      font-size: 1.1em;
    }

    .kpis {
      text-align: left;
      font-size: 0.9em;
      width: 100%;
    }

    .kpis p {
      margin: 6px 0;
      padding: 6px;
      background: rgba(255,255,255,0.04);
      border-radius: 6px;
    }

    .kpi-ok {
      color: #4caf50; /* verde */
      font-weight: bold;
    }
    .kpi-bad {
      color: #ff4c4c; /* rojo */
      font-weight: bold;
    }
  </style>
</head>
<body>

  <!-- ðŸ”¹ Header -->
  <header>
    <div class="top-row">
      <div>
        <h1>Dashboard Fuerza de Ventas</h1>
        <div class="subtitle">KPIs â€” Comisional & Incentivos</div>
      </div>
    </div>
    <div class="toolbar">
      <label for="year">AÃ±o:</label>
      <select id="year"></select>
      <label for="month">Mes:</label>
      <select id="month"></select>
      <button id="btn-ventas" onclick="toggleDataset('ventas')">Comisional</button>
      <button id="btn-incentivos" onclick="toggleDataset('incentivos')">Incentivos</button>
      <!-- ðŸ“„ BotÃ³n PDF -->
      <button onclick="exportarPDF()">ðŸ“„ Exportar PDF</button>
    </div>
  </header>

  <!-- ðŸ”¹ Contenido -->
  <div class="container">
    <div class="totales" id="totales"></div>
    <div class="cards" id="cards"></div>
  </div>

  <script>
    const meses = [
      "Enero","Febrero","Marzo","Abril","Mayo","Junio",
      "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
    ];
    let dataset = "ventas";
    let dataCache = {};

    async function cargarDatos(tipo) {
      const res = await fetch(`data/${tipo}.json`);
      return await res.json();
    }

    async function init() {
      dataCache["ventas"] = await cargarDatos("ventas");
      dataCache["incentivos"] = await cargarDatos("incentivos");

      const yearSel = document.getElementById("year");
      const years = Object.keys(dataCache["ventas"]);
      years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        yearSel.appendChild(opt);
      });

      yearSel.value = years[years.length-1];
      actualizarMeses();
      mostrarDatos();
    }

    function actualizarMeses() {
      const yearSel = document.getElementById("year").value;
      const monthSel = document.getElementById("month");
      monthSel.innerHTML = "";

      const months = Object.keys(dataCache[dataset][yearSel]).filter(m => dataCache[dataset][yearSel][m].length > 0);
      months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = meses[parseInt(m)-1];
        monthSel.appendChild(opt);
      });

      if (!months.includes(monthSel.value)) {
        monthSel.value = months[months.length-1];
      }
    }

    function toggleDataset(tipo) {
      const selectedYear = document.getElementById("year").value;
      const selectedMonth = document.getElementById("month").value;

      dataset = tipo;
      document.getElementById("btn-ventas").classList.remove("active");
      document.getElementById("btn-incentivos").classList.remove("active");
      document.getElementById(`btn-${tipo}`).classList.add("active");

      actualizarMeses();

      // Restaurar selecciÃ³n si existe
      if (Object.keys(dataCache[dataset][selectedYear] || {}).includes(selectedMonth)) {
        document.getElementById("year").value = selectedYear;
        document.getElementById("month").value = selectedMonth;
      }
      mostrarDatos();
    }

    function mostrarDatos() {
      const year = document.getElementById("year").value;
      const month = document.getElementById("month").value;
      const datos = dataCache[dataset][year][month];

      // ðŸ‘‰ Totales
      const totalesDiv = document.getElementById("totales");
      totalesDiv.innerHTML = `<h2>TOTAL POR KPI ${meses[parseInt(month)-1]}/${year}</h2>`;
      const acumulados = {};

      datos.forEach(v => {
        for (const k in v.kpis) {
          if (!acumulados[k]) acumulados[k] = {avance:0, meta:0};
          acumulados[k].avance += v.kpis[k].avance;
          acumulados[k].meta += v.kpis[k].meta;
        }
      });

      Object.keys(acumulados).forEach(kpi => {
        const {avance, meta} = acumulados[kpi];
        const porc = meta > 0 ? (avance/meta*100).toFixed(1) : 0;
        const div = document.createElement("div");
        div.className = "kpi-total";
        div.innerHTML = `
          <strong>${kpi.replace("_Avance","")}:</strong> 
          ${avance.toLocaleString()} de ${meta.toLocaleString()} â€” ${porc}%
          <canvas id="chart-${kpi}"></canvas>
        `;
        totalesDiv.appendChild(div);

        const ctx = document.getElementById(`chart-${kpi}`).getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: Array.from({length: 9}, (_, i) => i*20),
            datasets: [
              {
                label: "Avance",
                data: Array(9).fill(porc),
                borderColor: "limegreen",
                borderWidth: 2,
                fill: false,
              },
              {
                label: "Meta (100%)",
                data: Array(9).fill(100),
                borderColor: "red",
                borderWidth: 2,
                borderDash: [6,4],
                fill: false,
              }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { labels: { color: "#fff" } } },
            scales: {
              x: { ticks: { color: "#aaa" } },
              y: { min: 0, max: 160, ticks: { stepSize: 20, color: "#aaa" } }
            }
          }
        });
      });

      // ðŸ‘‰ Cards
      const cardsDiv = document.getElementById("cards");
      cardsDiv.innerHTML = "";
      datos.forEach(v => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="images/${v.foto}" alt="${v.nombre}">
          <h3>${v.nombre}</h3>
          <p><em>${v.zona}</em></p>
          <div class="kpis"></div>
        `;
        const kpisDiv = card.querySelector(".kpis");
        for (const k in v.kpis) {
          const {avance, meta} = v.kpis[k];
          const porc = meta > 0 ? (avance/meta*100).toFixed(1) : 0;
          const className = porc >= 100 ? "kpi-ok" : "kpi-bad";
          kpisDiv.innerHTML += `<p><strong class="${className}">${k.replace("_Avance","")}:</strong> ${avance.toLocaleString()} de ${meta.toLocaleString()} â€” ${porc}%</p>`;
        }
        cardsDiv.appendChild(card);
      });
    }

    document.getElementById("year").addEventListener("change", ()=>{ actualizarMeses(); mostrarDatos(); });
    document.getElementById("month").addEventListener("change", mostrarDatos);

    init();

    /* ===============================
       ðŸ“„ Exportar PDF (mejorado)
       - Panel general en 1Âª pÃ¡gina
       - 2 tarjetas por pÃ¡gina A4
       - Escala alta para textos nÃ­tidos
       - Fondo oscuro conservado
       =============================== */
    async function exportarPDF() {
      const { jsPDF } = window.jspdf;

      const year = document.getElementById("year").value;
      const month = document.getElementById("month").value;
      const titulo = `Dashboard Fuerza de Ventas â€” ${meses[parseInt(month)-1]} ${year}`;

      const pdf = new jsPDF("l", "mm", "a4")
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const margin = 10;

      // ðŸ‘‰ 1) Panel general (primera pÃ¡gina)
      const panel = document.getElementById("totales");
      const canvasPanel = await html2canvas(panel, {
        scale: 3,                 // alta definiciÃ³n
        useCORS: true,
        backgroundColor: "#111",
        windowWidth: panel.scrollWidth,
        windowHeight: panel.scrollHeight
      });

      const imgPanel = canvasPanel.toDataURL("image/png");
      // altura proporcional limitada a la pÃ¡gina
      const maxPanelHeight = pdfHeight - 30; // deja espacio para tÃ­tulo
      const panelHeight = Math.min(
        maxPanelHeight,
        (canvasPanel.height * pdfWidth) / canvasPanel.width
      );

      pdf.setFontSize(14);
      pdf.text(titulo, margin, 15);
      pdf.addImage(imgPanel, "PNG", 0, 25, pdfWidth, panelHeight);

      // ðŸ‘‰ 2) Tarjetas de vendedores (2 por pÃ¡gina)
      const cards = document.querySelectorAll(".card");
      const halfPageHeight = (pdfHeight - margin * 3) / 2; // espacio Ãºtil por tarjeta

      for (let i = 0; i < cards.length; i++) {
        // cada dos tarjetas: nueva hoja
        if (i % 2 === 0) pdf.addPage();

        const card = cards[i];
        const canvasCard = await html2canvas(card, {
          scale: 3,
          useCORS: true,
          backgroundColor: "#111",
          windowWidth: card.scrollWidth,
          windowHeight: card.scrollHeight
        });

        const imgCard = canvasCard.toDataURL("image/png");
        // tamaÃ±o destino ajustado a ancho con tope de alto (para no cortar texto)
        const targetWidth = pdfWidth - margin * 2;
        let targetHeight = (canvasCard.height * targetWidth) / canvasCard.width;
        if (targetHeight > halfPageHeight) targetHeight = halfPageHeight;

        const yPos = (i % 2 === 0) ? margin : margin + halfPageHeight + margin;
        pdf.addImage(imgCard, "PNG", margin, yPos, targetWidth, targetHeight);
      }

      pdf.save(`dashboard_${year}_${month}.pdf`);
    }
  </script>
</body>
</html>
