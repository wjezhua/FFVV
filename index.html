<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Fuerza de Ventas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 20px;
      background: linear-gradient(90deg, #0f2027, #203a43, #2c5364);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(6px);
    }
    header h1 {
      margin: 0;
      font-size: 1.8em;
      font-weight: 700;
    }
    header .subtitle {
      font-size: 0.9em;
      opacity: 0.8;
    }
    .toolbar {
      background: rgba(30,30,30,0.85);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      padding: 12px 15px;
      border-bottom: 2px solid #2c2c2c;
      position: sticky;
      top: 70px;
      z-index: 999;
      backdrop-filter: blur(6px);
    }
    select, button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
      background: #2a2a2a;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }
    select:hover, button:hover {
      background: #007bff;
      color: #fff;
    }
    button.active {
      background: #007bff;
      font-weight: bold;
    }
    .general-card {
      background: #2a2a2a;
      margin: 20px;
      padding: 20px;
      border-radius: 12px;
    }
    .general-card h2 {
      margin-top: 0;
      font-size: 1.2em;
    }
    .kpi {
      margin-bottom: 25px;
    }
    canvas {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 10px;
      height: 140px !important;
    }
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      padding: 15px;
    }
    .card {
      background: #1e1e1e;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.6);
    }
    .card img {
      width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #007bff;
      margin-bottom: 10px;
    }
    .card h3 {
      margin: 8px 0 4px;
      font-size: 1.2em;
    }
    .card p {
      font-size: 0.9em;
      color: #aaa;
      margin-bottom: 10px;
    }
    .card .kpi-item {
      font-size: 0.9em;
      margin: 5px 0;
      padding: 6px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
    }
    .card .kpi-item strong {
      color: #4CAF50;
    }

    /* ðŸ“± Mejoras en mÃ³viles */
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px;
      }
      header h1 {
        font-size: 1.5em;
      }
      header .subtitle {
        font-size: 0.8em;
      }
      .toolbar {
        flex-direction: column;
        gap: 8px;
        padding: 10px;
      }
      select, button {
        width: 100%;
        font-size: 1em;
      }
      .card img {
        width: 90px;
        height: 90px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Dashboard Fuerza de Ventas</h1>
      <div class="subtitle">Seguimiento de KPIs â€” Comisional & Incentivos</div>
    </div>
  </header>

  <div class="toolbar">
    <label for="year">AÃ±o:</label>
    <select id="year"></select>
    <label for="month">Mes:</label>
    <select id="month"></select>
    <button id="btn-ventas" onclick="toggleDataset('ventas')">Comisional</button>
    <button id="btn-incentivos" onclick="toggleDataset('incentivos')">Incentivos</button>
  </div>

  <div id="general-summary"></div>
  <div class="cards-container" id="cards-container"></div>

  <script>
    let dataVentas = {}, dataIncentivos = {};
    let currentDataset = "ventas";
    const charts = {};
    const monthNames = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

    async function init(){
      dataVentas = await fetch("data/ventas.json").then(r=>r.json());
      dataIncentivos = await fetch("data/incentivos.json").then(r=>r.json());

      const selYear = document.getElementById("year");
      const years = Object.keys(dataVentas);
      selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
      selYear.value = new Date().getFullYear();

      updateMonths();
      render();

      selYear.addEventListener("change",()=>{updateMonths(); render();});
      document.getElementById("month").addEventListener("change",render);
    }

    function updateMonths(){
      const y=document.getElementById("year").value;
      const data=(currentDataset==="ventas"?dataVentas:dataIncentivos);
      const selMonth=document.getElementById("month");
      if(!data[y]){selMonth.innerHTML="";return;}
      const meses=Object.keys(data[y]).sort();
      selMonth.innerHTML=meses.map(m=>{
        const nombre=monthNames[parseInt(m,10)-1];
        return `<option value="${m}">${nombre}</option>`;
      }).join("");
      selMonth.value=meses.includes((new Date().getMonth()+1).toString().padStart(2,"0")) ?
                     (new Date().getMonth()+1).toString().padStart(2,"0") :
                     meses[0];
    }

    function toggleDataset(ds){
      currentDataset = ds;
      document.getElementById("btn-ventas").classList.toggle("active",ds==="ventas");
      document.getElementById("btn-incentivos").classList.toggle("active",ds==="incentivos");
      updateMonths();
      render();
    }

    function render(){
      const y=document.getElementById("year").value;
      const m=document.getElementById("month").value;
      const data=(currentDataset==="ventas"?dataVentas:dataIncentivos);
      const vendedores=data?.[y]?.[m]||[];
      renderGeneralByKPI(vendedores,y,m);
      renderCards(vendedores,y,m);
    }

    function renderGeneralByKPI(vendedores,year,month){
      const totales={};
      vendedores.forEach(v=>{
        Object.entries(v.kpis||{}).forEach(([k,vals])=>{
          if(!totales[k]) totales[k]={avance:0,meta:0};
          totales[k].avance += Number(vals.avance)||0;
          totales[k].meta += Number(vals.meta)||0;
        });
      });
      const cont=document.getElementById("general-summary");
      const keys=Object.keys(totales);
      if(keys.length===0){cont.innerHTML="";return;}

      let html=`<div class="general-card"><h2>TOTAL POR KPI ${monthNames[parseInt(month)-1]} ${year}</h2>`;
      keys.forEach(k=>{
        const a=totales[k].avance,m=totales[k].meta,p=m>0?(a/m*100):0;
        html+=`
          <div class="kpi">
            <strong>${k}</strong>: ${fmtNumber(a)} de ${fmtNumber(m)} â€” ${p.toFixed(1)}%
            <canvas id="${kpiId(k)}"></canvas>
          </div>`;
      });
      html+=`</div>`;
      cont.innerHTML=html;

      keys.forEach(k=>{
        const id=kpiId(k);
        const a=totales[k].avance,m=totales[k].meta,p=m>0?(a/m*100):0;
        if(charts[id]) charts[id].destroy();
        const ctx=document.getElementById(id);
        charts[id]=new Chart(ctx,{
          type:"line",
          data:{
            labels:[0,100],
            datasets:[
              {label:"Avance",data:[0,p],borderColor:"#4CAF50",borderWidth:3,fill:false,tension:0},
              {label:"Meta (100%)",data:[0,100],borderColor:"red",borderDash:[6,6],borderWidth:2,fill:false,tension:0}
            ]
          },
          options:{
            responsive:true,maintainAspectRatio:false,
            plugins:{legend:{labels:{color:"#fff"}},tooltip:{enabled:true}},
            scales:{x:{display:false},y:{min:0,max:160,ticks:{stepSize:20,color:"#fff"},grid:{color:"rgba(255,255,255,0.1)"}}},
            elements:{point:{radius:0}}
          }
        });
      });
    }

    function renderCards(vendedores,year,month){
      const cont=document.getElementById("cards-container");
      cont.innerHTML=vendedores.map(v=>{
        let kpiHtml="";
        for(const [k,vals] of Object.entries(v.kpis||{})){
          const pct = vals.meta>0 ? (vals.avance/vals.meta*100) : 0;
          kpiHtml+=`<div class="kpi-item"><strong>${k.replace(/_.*$/,"")}</strong>: ${fmtNumber(vals.avance)} de ${fmtNumber(vals.meta)} â€” ${pct.toFixed(1)}%</div>`;
        }
        return `
          <div class="card">
            <img src="images/${v.foto}" alt="${v.nombre}">
            <h3>${v.nombre}</h3>
            <p>${v.zona} ${v.vigente?"<span style='color:lime'>(Mes en curso)</span>":""}</p>
            ${kpiHtml}
          </div>`;
      }).join("");
    }

    const fmtNumber=n=>Number(n).toLocaleString("es-PE",{maximumFractionDigits:1});
    const kpiId=k=>"chart_"+k.replace(/\W/g,"_");

    init();
  </script>
</body>
</html>
