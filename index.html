<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Fuerza de Ventas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    header {
      text-align: center;
      padding: 20px;
      background: linear-gradient(90deg, #1e3c72, #2a5298);
    }
    header h1 { margin: 0; font-size: 2.5em; }
    header p { margin: 5px 0 0; }
    .filters {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 15px;
      background: #1e1e1e;
    }
    select, button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      font-size: 1em;
    }
    button {
      cursor: pointer;
      background: #007bff;
      color: #fff;
    }
    .general-card {
      background: #2a2a2a;
      margin: 20px;
      padding: 20px;
      border-radius: 12px;
    }
    .general-card h2 {
      margin-top: 0;
      color: #fff;
    }
    .kpi {
      margin-bottom: 25px;
    }
    canvas {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 10px;
      height: 180px !important;
    }
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }
    .card img {
      width: 100%;
      max-width: 200px;
      border-radius: 50%;
    }
    .card h3 {
      margin: 10px 0 5px;
    }
    .card .kpi-item {
      font-size: 0.9em;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Dashboard Fuerza de Ventas</h1>
    <p>Seguimiento de KPIs — Comisional & Incentivos</p>
  </header>

  <div class="filters">
    <label for="year">Año:</label>
    <select id="year"></select>
    <label for="month">Mes:</label>
    <select id="month"></select>
    <button onclick="toggleDataset('ventas')">Comisional</button>
    <button onclick="toggleDataset('incentivos')">Incentivos</button>
  </div>

  <div id="general-summary"></div>
  <div class="cards-container" id="cards-container"></div>

  <script>
    let dataVentas = {}, dataIncentivos = {};
    let currentDataset = "ventas";
    const charts = {};

    async function init(){
      dataVentas = await fetch("data/ventas.json").then(r=>r.json());
      dataIncentivos = await fetch("data/incentivos.json").then(r=>r.json());

      const years = Object.keys(dataVentas);
      const selYear = document.getElementById("year");
      selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
      selYear.value = new Date().getFullYear();

      const selMonth = document.getElementById("month");
      selMonth.innerHTML = Array.from({length:12},(_,i)=>{
        const m = (i+1).toString().padStart(2,"0");
        return `<option value="${m}">${m}</option>`;
      }).join("");
      selMonth.value = (new Date().getMonth()+1).toString().padStart(2,"0");

      render();
      selYear.addEventListener("change",render);
      selMonth.addEventListener("change",render);
    }

    function toggleDataset(ds){
      currentDataset = ds;
      render();
    }

    function render(){
      const y=document.getElementById("year").value;
      const m=document.getElementById("month").value;
      const data=(currentDataset==="ventas"?dataVentas:dataIncentivos);
      const vendedores=data?.[y]?.[m]||[];
      renderGeneralByKPI(vendedores,y,m);
      renderCards(vendedores,y,m);
    }

    function renderGeneralByKPI(vendedores,year,month){
      const totales={};
      vendedores.forEach(v=>{
        Object.entries(v.kpis||{}).forEach(([k,vals])=>{
          if(!totales[k]) totales[k]={avance:0,meta:0};
          totales[k].avance += Number(vals.avance)||0;
          totales[k].meta += Number(vals.meta)||0;
        });
      });
      const cont=document.getElementById("general-summary");
      const keys=Object.keys(totales);
      if(keys.length===0){cont.innerHTML="";return;}

      let html=`<div class="general-card"><h2>TOTAL POR KPI ${month}/${year}</h2>`;
      keys.forEach(k=>{
        const a=totales[k].avance,m=totales[k].meta,p=m>0?(a/m*100):0;
        html+=`
          <div class="kpi">
            <strong>${k}</strong>: ${fmtNumber(a)} de ${fmtNumber(m)} — ${p.toFixed(1)}%
            <canvas id="${kpiId(k)}"></canvas>
          </div>`;
      });
      html+=`</div>`;
      cont.innerHTML=html;

      keys.forEach(k=>{
        const id=kpiId(k);
        const a=totales[k].avance,m=totales[k].meta,p=m>0?(a/m*100):0;
        if(charts[id]) charts[id].destroy();
        const ctx=document.getElementById(id);

        charts[id]=new Chart(ctx,{
          type:"line",
          data:{
            labels:[0,100],
            datasets:[
              {
                label:"Avance",
                data:[0,p],
                borderColor:"#4CAF50",
                borderWidth:3,
                fill:false,
                tension:0
              },
              {
                label:"Meta (100%)",
                data:[0,100],
                borderColor:"red",
                borderDash:[6,6],
                borderWidth:2,
                fill:false,
                tension:0
              }
            ]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
              legend:{labels:{color:"#fff"}},
              tooltip:{enabled:true}
            },
            scales:{
              x:{
                display:false
              },
              y:{
                min:0,max:160,
                ticks:{stepSize:20,color:"#fff"},
                grid:{color:"rgba(255,255,255,0.1)"}
              }
            },
            elements:{point:{radius:0}}
          }
        });
      });
    }

    function renderCards(vendedores,year,month){
      const cont=document.getElementById("cards-container");
      cont.innerHTML=vendedores.map(v=>{
        let kpiHtml="";
        for(const [k,vals] of Object.entries(v.kpis||{})){
          const pct=Number(vals.porcentaje)||0;
          kpiHtml+=`<div class="kpi-item"><strong>${k.replace(/_.*$/,"")}</strong>: ${fmtNumber(vals.avance)} de ${fmtNumber(vals.meta)} — ${pct.toFixed(1)}%</div>`;
        }
        return `
          <div class="card">
            <img src="images/${v.foto}" alt="${v.nombre}">
            <h3>${v.nombre}</h3>
            <p>${v.zona} ${v.vigente?"<span style='color:lime'>(Mes en curso)</span>":""}</p>
            ${kpiHtml}
          </div>`;
      }).join("");
    }

    const fmtNumber=n=>Number(n).toLocaleString("es-PE",{maximumFractionDigits:1});
    const kpiId=k=> "chart_"+k.replace(/\W/g,"_");

    init();
  </script>
</body>
</html>
